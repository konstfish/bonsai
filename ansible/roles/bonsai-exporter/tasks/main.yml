---

- name: Get updated files from git repository 
  git: 
    repo: "https://{{ github_user | urlencode }}:{{ github_token | urlencode }}@github.com/konstfish/bonsai.git"
    dest: /home/{{ user_name }}/docker/bonsai-clone

- name: Delete old directory
  file:
    state: absent
    path: /home/{{ user_name }}/docker/bonsai_exporter/

- name: Copy cloned repo 
  ansible.builtin.copy:
    src: /home/{{ user_name }}/docker/bonsai-clone/bonsai_exporter_base/
    dest: /home/{{ user_name }}/docker/bonsai_exporter/
    remote_src: true

- name: Template docker-compose file
  template:
    src: "docker-compose.yml.j2"
    dest: "/home/{{ user_name }}/docker/bonsai_exporter/docker-compose.yml"

- name: Template bonsai config file
  template:
    src: "bonsai-config.yaml.j2"
    dest: "/home/{{ user_name }}/docker/bonsai_exporter/config-ansible.yaml"

- name: Deploy bonsai exporter
  docker_compose:
    project_src: /home/{{ user_name }}/docker/bonsai_exporter
    state: present
    build: true
    restarted: true
    recreate: always
